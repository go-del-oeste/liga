<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Liga Go Extremeña — Seguimiento</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Pequeñas mejoras visuales */
    .placeholder-img{background:#f3f4f6;display:inline-block;width:56px;height:56px;border-radius:6px;align-items:center;justify-content:center;display:flex;color:#9ca3af}
    .card{background:white;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-6">
  <div class="max-w-5xl mx-auto">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">Liga Go Extremeña</h1>
      <p class="text-sm text-gray-500">Página simple para seguir la liga. Actualiza <code>league.md</code> en el repositorio para cambiar datos.</p>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <section id="nextMatches" class="md:col-span-2">
        <div class="card">
          <h2 class="text-xl font-semibold mb-2">Partidas próximas</h2>
          <div id="nextList" class="space-y-2">Cargando...</div>
        </div>

        <div class="mt-4 card">
          <h2 class="text-xl font-semibold mb-2">Partidas pasadas</h2>
          <div id="pastList" class="space-y-2">Cargando...</div>
        </div>
      </section>

      <aside>
        <div class="card">
          <h2 class="text-xl font-semibold mb-2">Clasificación</h2>
          <div id="standings">Cargando...</div>
        </div>

        <div class="mt-4 card">
          <h3 class="font-medium mb-2">Equipos</h3>
          <div id="teamsList" class="space-y-2">Cargando...</div>
        </div>
      </aside>
    </main>

    <footer class="mt-6 text-xs text-gray-500">Formato de datos: <code>league.md</code>. Cambia el archivo en GitHub y la página leerá los datos. (Ver instrucciones en el repositorio)</footer>
  </div>

<script>
/*
  INSTRUCCIONES y EJEMPLO de league.md (cópialo en tu repo como league.md)

  ## Teams
  - id|ShortName|Full Name|images/team-id.png
  - 1|Alange|Club Go Alange|images/alange.png
  - 2|Coria|Go Coria|images/coria.png
  (la imagen es opcional; si no existe se muestra un placeholder)

  ## Matches
  - 2025-10-11 18:30 | 1 vs 2 |    <-- partida sin resultado (próxima)
  - 2025-09-28 19:00 | 2 vs 1 | 2-1  <-- partida pasada con resultado (goles locales - visitantes)
  - 2025-10-05 20:00 | 1 vs 3 | 0-0

  ## Standings  (OPCIONAL)
  - 1|Alange|0|0|0|0|0|0|0  <-- si incluyes tabla manual (id|Name|PJ|G|E|P|GF|GC|Pts)

  Nota: Si no incluyes sección Standings la página calculará la clasificación a partir de los resultados que sí tengan marcador.
*/

// Utilidades de parseado
function parseLeague(md){
  const sections = {};
  const lines = md.split(/\n/);
  let cur = null;
  for(const raw of lines){
    const line = raw.trim();
    if(line.startsWith('## ')){
      cur = line.slice(3).trim();
      sections[cur] = [];
    }else if(cur && line.length){
      sections[cur].push(line);
    }
  }
  return sections;
}

function parseTeams(lines){
  // - id|Short|Full|img
  const teams = {};
  for(const l of lines){
    if(!l.startsWith('-')) continue;
    const content = l.replace(/^-\s*/,'');
    const parts = content.split('|').map(s=>s.trim());
    const id = parts[0];
    teams[id] = {id, short:parts[1]||(`T${id}`), name:parts[2]||parts[1]||(`Team ${id}`), img:parts[3]||null};
  }
  return teams;
}

function parseMatches(lines){
  // - YYYY-MM-DD HH:MM | home vs away | score(optional)
  const matches = [];
  for(const l of lines){
    if(!l.startsWith('-')) continue;
    const content = l.replace(/^-\s*/,'');
    const parts = content.split('|').map(s=>s.trim());
    const when = parts[0];
    const vs = parts[1]||'';
    const score = parts[2]||'';
    const vsMatch = vs.match(/(\d+)\s*vs\s*(\d+)/i);
    if(!vsMatch) continue;
    const home = vsMatch[1];
    const away = vsMatch[2];
    let homeScore=null, awayScore=null;
    const scoreMatch = score.match(/(\d+)\s*-\s*(\d+)/);
    if(scoreMatch){ homeScore = parseInt(scoreMatch[1]); awayScore = parseInt(scoreMatch[2]); }
    // parse date (assume local timezone)
    const dt = new Date(when.replace(' ','T'));
    matches.push({raw:content, when:dt, whenText:when, home, away, homeScore, awayScore});
  }
  return matches.sort((a,b)=>a.when - b.when);
}

function parseStandings(lines){
  // Optional manual standings lines: - id|Name|PJ|G|E|P|GF|GC|Pts
  const rows = [];
  for(const l of lines){
    if(!l.startsWith('-')) continue;
    const c = l.replace(/^-\s*/,'');
    const p = c.split('|').map(s=>s.trim());
    if(p.length >= 9){
      rows.push({id:p[0], name:p[1], pj:+p[2], w:+p[3], d:+p[4], l:+p[5], gf:+p[6], gc:+p[7], pts:+p[8]});
    }
  }
  return rows;
}

function computeStandingsFromMatches(matches, teams){
  const tbl = {};
  Object.values(teams).forEach(t=>{ tbl[t.id] = {id:t.id, name:t.short||t.name, pj:0,w:0,d:0,l:0,gf:0,gc:0,pts:0}; });
  for(const m of matches){
    if(m.homeScore==null || m.awayScore==null) continue; // skip incomplete
    const h = tbl[m.home];
    const a = tbl[m.away];
    if(!h || !a) continue;
    h.pj++; a.pj++;
    h.gf += m.homeScore; h.gc += m.awayScore;
    a.gf += m.awayScore; a.gc += m.homeScore;
    if(m.homeScore > m.awayScore){ h.w++; a.l++; h.pts += 3; }
    else if(m.homeScore < m.awayScore){ a.w++; h.l++; a.pts += 3; }
    else { h.d++; a.d++; h.pts += 1; a.pts +=1; }
  }
  const arr = Object.values(tbl);
  arr.sort((x,y)=>{
    if(y.pts !== x.pts) return y.pts - x.pts;
    const gdY = y.gf - y.gc; const gdX = x.gf - x.gc;
    if(gdY !== gdX) return gdY - gdX;
    if(y.gf !== x.gf) return y.gf - x.gf;
    return x.name.localeCompare(y.name);
  });
  return arr;
}

function renderTeams(teams){
  const el = document.getElementById('teamsList'); el.innerHTML='';
  for(const t of Object.values(teams)){
    const d = document.createElement('div'); d.className='flex items-center gap-3';
    const img = document.createElement('img'); img.width=40; img.height=40; img.alt=t.short;
    img.style.borderRadius='6px';
    if(t.img){ img.src = t.img; img.onerror = ()=>{ img.style.display='none'; d.querySelector('.placeholder-img').style.display='flex'; } }
    else img.style.display='none';
    const ph = document.createElement('div'); ph.className='placeholder-img'; ph.textContent = t.short.slice(0,2).toUpperCase();
    const info = document.createElement('div'); info.innerHTML = `<div class="font-medium">${t.short}</div><div class="text-xs text-gray-500">${t.name}</div>`;
    d.appendChild(img); d.appendChild(ph); d.appendChild(info);
    el.appendChild(d);
  }
}

function renderMatches(matches, teams){
  const now = new Date();
  const next = matches.filter(m=>m.when > now);
  const past = matches.filter(m=>m.when <= now).slice().reverse();

  const nextList = document.getElementById('nextList'); nextList.innerHTML='';
  if(next.length===0) nextList.innerHTML = '<div class="text-sm text-gray-500">No hay partidas próximas.</div>';
  for(const m of next.slice(0,20)){
    const el = document.createElement('div'); el.className='flex items-center justify-between gap-3 p-2 border rounded';
    const left = document.createElement('div'); left.className='flex items-center gap-3';
    const h = teams[m.home]||{short:m.home}; const a = teams[m.away]||{short:m.away};
    left.innerHTML = `<div class=\"text-sm\">${m.whenText}</div><div class=\"ml-3 text-sm\"><strong>${h.short}</strong> vs <strong>${a.short}</strong></div>`;
    el.appendChild(left);
    const right = document.createElement('div'); right.className='text-xs text-gray-500'; right.textContent = (m.homeScore==null? 'Pendiente' : `${m.homeScore}-${m.awayScore}`);
    el.appendChild(right);
    nextList.appendChild(el);
  }

  const pastList = document.getElementById('pastList'); pastList.innerHTML='';
  if(past.length===0) pastList.innerHTML = '<div class="text-sm text-gray-500">No hay partidas pasadas.</div>';
  for(const m of past.slice(0,50)){
    const el = document.createElement('div'); el.className='flex items-center justify-between gap-3 p-2 border rounded';
    const h = teams[m.home]||{short:m.home}; const a = teams[m.away]||{short:m.away};
    el.innerHTML = `<div><div class="text-sm">${m.whenText}</div><div class="text-sm"><strong>${h.short}</strong> ${m.homeScore!=null?m.homeScore:'-'} - ${m.awayScore!=null?m.awayScore:'-'} <strong>${a.short}</strong></div></div><div class="text-xs text-gray-500">${m.homeScore==null? 'Sin resultado' : 'Finalizado'}</div>`;
    pastList.appendChild(el);
  }
}

function renderStandings(rows){
  const el = document.getElementById('standings'); el.innerHTML='';
  if(!rows || rows.length===0){ el.innerHTML = '<div class="text-sm text-gray-500">Sin datos de clasificación.</div>'; return; }
  const table = document.createElement('table'); table.className='w-full text-sm';
  const h = document.createElement('thead'); h.innerHTML = `<tr class="text-left text-xs text-gray-500"><th>#</th><th>Equipo</th><th>PJ</th><th>G</th><th>E</th><th>P</th><th>GF</th><th>GC</th><th>Pts</th></tr>`;
  table.appendChild(h);
  const b = document.createElement('tbody');
  rows.forEach((r,i)=>{
    const tr = document.createElement('tr'); tr.className='border-t';
    tr.innerHTML = `<td class="py-1">${i+1}</td><td>${r.name}</td><td>${r.pj}</td><td>${r.w}</td><td>${r.d}</td><td>${r.l}</td><td>${r.gf}</td><td>${r.gc}</td><td><strong>${r.pts}</strong></td>`;
    b.appendChild(tr);
  });
  table.appendChild(b);
  el.appendChild(table);
}

async function loadAndRender(){
  let md = null;
  try{
    const resp = await fetch('league.md');
    if(!resp.ok) throw new Error('no league.md');
    md = await resp.text();
  }catch(e){
    // fallback: ejemplo embebido para que la página funcione incluso sin archivo
    //md = `## Teams\n- 1|Alange|Club Go Alange|images/alange.png\n- 2|Coria|Go Coria|images/coria.png\n- 3|Plasencia|Go Plasencia|\n\n## Matches\n- 2025-10-11 18:30 | 1 vs 2 |\n- 2025-09-28 19:00 | 2 vs 1 | 2-1\n- 2025-10-05 20:00 | 1 vs 3 | 0-0\n\n## Standings\n- 1|Alange|3|2|1|0|5|2|7\n- 2|Coria|3|1|0|2|3|4|3\n- 3|Plasencia|3|0|1|2|1|3|1\`;
  }

  const sections = parseLeague(md);
  const teams = parseTeams(sections['Teams']||[]);
  const matches = parseMatches(sections['Matches']||[]);
  const manualStand = parseStandings(sections['Standings']||[]);
  const computedStand = computeStandingsFromMatches(matches, teams);

  renderTeams(teams);
  renderMatches(matches, teams);
  renderStandings(manualStand.length? manualStand : computedStand);
}

loadAndRender();
</script>
</body>
</html>
