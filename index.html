<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Liga Go Extremeña — Seguimiento</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .placeholder-img{background:#f3f4f6;display:inline-block;width:40px;height:40px;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-weight:bold}
    .card{background:white;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-6">
  <div class="max-w-5xl mx-auto">
    <header class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div>
        <h1 class="text-3xl font-bold">Liga Go Extremeña</h1>
        <p class="text-sm text-gray-500">Selecciona una liga y navega por las jornadas</p>
      </div>
      <select id="leagueSelector" class="border rounded p-1 text-sm w-40">
        <option value="temporada24.md">Temporada 24</option>
        <option value="temporada25.md" selected>Temporada 25</option>
      </select>
    </header>

    <section id="navigation" class="flex justify-between items-center mb-4">
      <button id="prevJornada" class="px-3 py-1 bg-gray-200 rounded text-sm">◀ Jornada anterior</button>
      <div id="jornadaTitle" class="font-semibold text-lg">Cargando...</div>
      <button id="nextJornada" class="px-3 py-1 bg-gray-200 rounded text-sm">Siguiente jornada ▶</button>
    </section>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <section id="matchesSection" class="md:col-span-2">
        <div id="matchesContainer" class="space-y-4"></div>
      </section>

      <aside>
        <div class="card">
          <h2 class="text-xl font-semibold mb-2">Clasificación</h2>
          <div id="standings" class="text-sm">Cargando...</div>
        </div>
      </aside>
    </main>

    <footer class="mt-6 text-xs text-gray-500">
      Formato de datos: Jugadores y Jornadas en tablas Markdown. Actualiza el archivo <code>ligaXX.md</code> en el repositorio.
    </footer>
  </div>

<script>
function parseMarkdownTables(md){
  const sections = {};
  let current = null;
  const lines = md.split(/\n/);
  for (const line of lines) {
    const trimmed = line.trim();
    if (trimmed.startsWith('## ')) { current = trimmed.slice(3).trim(); sections[current]=[]; }
    else if (trimmed.startsWith('### ')) { current = trimmed.slice(4).trim(); sections[current]=[]; }
    else if(current && trimmed.length) { sections[current].push(trimmed); }
  }
  return sections;
}

function parseTable(lines) {
    console.log('Parsing table:', lines);
  const cleanLines = lines.map(l=>l.trim()).filter(l=>l && l.startsWith('|'));
  if(cleanLines.length<2) return [];
  const headers = cleanLines[0].split('|').map(s=>s.trim()).filter(Boolean);
  const data=[];
  for(const l of cleanLines.slice(2)) {
    const cells = l.split('|').map(s=>s.trim()).slice(1, -1);
    console.log('Row cells:', headers, cells);
    if(cells.length===headers.length){ const row={}; headers.forEach((h,i)=>row[h]=cells[i]); data.push(row); }
    console.log('data:', data);
  }
  return data;
}

function renderPlayers(players){ const map={}; players.forEach(p=>map[p.id]=p); return map; }

function renderStandings(rows){
  const el=document.getElementById('standings'); el.innerHTML='';
  if(!rows.length){ el.textContent='Sin datos'; return; }
  const table=document.createElement('table'); table.className='w-full text-sm';
  table.innerHTML=`<thead><tr class='text-xs text-gray-500 text-left'><th>#</th><th>Jugador</th><th>PJ</th><th>G</th><th>P</th><th>Diff</th><th>Pts</th></tr></thead>`;
  const tb=document.createElement('tbody');
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr'); tr.className='border-t';
    tr.innerHTML=`<td>${i+1}</td><td>${r.Nombre}</td><td>${r.PJ}</td><td>${r.G}</td><td>${r.P}</td><td>${r.Diff}</td><td><strong>${r.Pts}</strong></td>`;
    tb.appendChild(tr);
  });
  table.appendChild(tb); el.appendChild(table);
}

function computeStandings(sections, players){
  const stats={}; Object.values(players).forEach(p=>stats[p.id]={id:p.id,Nombre:p.Nombre,PJ:0,G:0,P:0,Diff:0,Pts:0});
  Object.keys(sections).filter(k=>k.toLowerCase().includes('jornada')).forEach(jk=>{
    const matches=parseTable(sections[jk]);
    matches.forEach(m=>{
      const res=(m['Resultado']||'').trim(); if(res!=='W'&&res!=='B') return;
      const white=m['Blanco'], black=m['Negro'];
      const diff= m['Diferencia']?parseFloat(m['Diferencia']):0
      stats[white].PJ++; stats[black].PJ++;
      if(res==='W'){stats[white].G++; stats[white].Pts+=3; stats[white].Diff+=diff; stats[black].P++; stats[black].Diff-=diff;}
      if(res==='B'){stats[black].G++; stats[black].Pts+=3; stats[black].Diff+=diff; stats[white].P++; stats[white].Diff-=diff;}
    });
  });
  return Object.values(stats).sort((a,b)=>b.Pts-a.Pts||b.Diff-a.Diff||a.Nombre.localeCompare(b.Nombre));
}

function renderJornada(jornadaName, matches, players){
  const container=document.getElementById('matchesContainer'); container.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  //card.innerHTML=`<h2 class='text-xl font-semibold mb-2'>${jornadaName}</h2>`;
  const list=document.createElement('div'); list.className='space-y-2';
  const table=parseTable(matches);
  table.forEach(m=>{
  const el=document.createElement('div'); el.className='border rounded p-2';
  const wb=players[m['Blanco']]?.Nombre||m['Blanco'];
  const wn=players[m['Negro']]?.Nombre||m['Negro'];
  const wbImg=players[m['Blanco']]?.Imagen||'';
  const wnImg=players[m['Negro']]?.Imagen||'';
  const res=(m['Resultado']||'').trim();
  const diff=m['Diferencia']?` +${m['Diferencia']}`:''
  const winner=res==='W'?`Ganó: <strong>${wb}</strong> ${diff}`:res==='B'?`Ganó: <strong>${wn}</strong> ${diff}`:'Pendiente';

  el.innerHTML=`
    <div class='text-center mt-1'>${m['Fecha']}</div>
    <div class='flex items-center justify-between w-full'>
      <div class='flex items-center gap-2'>
        ${wbImg?`<img src='${wbImg}' class='w-24 h-24 rounded-full border' alt='${wb}'>`:''}
        <strong>${wb}</strong> <div class="text-2xl">⚪</div>
      </div>
      <span>vs</span>
      <div class='flex items-center gap-2'>
       <div class="text-2xl">⚫</div> <strong>${wn}</strong>  ${wnImg?`<img src='${wnImg}' class='w-24 h-24 rounded-full border' alt='${wn}'>`:''}
        
      </div>
    </div>
    <div class='text-center mt-1'>${winner}</div>
    <div class='text-gray-500'>${m['Observaciones']||''}</div>
  `;
  list.appendChild(el);
});
card.appendChild(list); 
container.appendChild(card);
}


async function loadLeague(file){
  let md='';
  try{ const resp=await fetch(file); if(!resp.ok) throw 0; md=await resp.text(); } catch{ md=`## Jugadores\n| id | Nombre | Imagen |\n|----|---------|--------|\n| 1 | Juan | |\n| 2 | Ana | |\n\n## Jornadas\n### Jornada 1\n| Fecha | Blanco | Negro | Resultado | Observaciones |\n|--------|---------|--------|------------|----------------|\n| 2025-10-11 18:30 | 1 | 2 | | Ejemplo |`;}
  const sections=parseMarkdownTables(md);
  const players=parseTable(sections['Jugadores']||[]);
  const playersMap=renderPlayers(players);

  const jornadaKeys=Object.keys(sections).filter(k=>k.toLowerCase().includes('jornada'));
  console.log(jornadaKeys)
  let currentIndex=0;
  function showJornada(index){
    if(index<0) index=0; if(index>=jornadaKeys.length) index=jornadaKeys.length-1;
    currentIndex=index;
    const key=jornadaKeys[index];
    document.getElementById('jornadaTitle').textContent=key;
    renderJornada(key, sections[key], playersMap);
  }

  document.getElementById('prevJornada').onclick=()=>showJornada(currentIndex-1);
  document.getElementById('nextJornada').onclick=()=>showJornada(currentIndex+1);

  renderStandings(computeStandings(sections,playersMap));
  let defaultIndex = 0;
    jornadaKeys.forEach((k,i)=>{
        if(k.toLowerCase().includes('actual')) defaultIndex = i;
    });
    showJornada(defaultIndex);
}

document.getElementById('leagueSelector').addEventListener('change',e=>loadLeague(e.target.value));
loadLeague(document.getElementById('leagueSelector').value);
</script>
</body>
</html>
